name: PR Triage Agent

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Apply labels, reviewers, and checklist
        uses: actions/github-script@v7
        env:
          DEFAULT_REVIEWERS: "${{ github.repository_owner }}"
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const labels = new Set();
            let touchesConfig = false;
            let touchesDocs = false;

            for (const file of files) {
              const path = file.filename;
              if (path.startsWith('src/') || path.startsWith('public/') || ['index.html'].includes(path)) {
                labels.add('area:frontend');
              }
              if (['vite.config.js', 'tailwind.config.js', 'postcss.config.js', 'eslint.config.js', 'nginx.conf'].includes(path) || path.startsWith('.github/')) {
                touchesConfig = true;
              }
              if (path === 'package.json' || path === 'package-lock.json') {
                labels.add('dependencies');
              }
              if (path.startsWith('docs/') || path === 'README.md' || path === 'CHANGELOG.md') {
                touchesDocs = true;
              }
              if (path === 'Dockerfile') {
                labels.add('area:devops');
              }
            }

            if (touchesConfig) labels.add('area:config');
            if (touchesDocs) labels.add('area:docs');

            const labelArray = Array.from(labels);
            if (labelArray.length > 0) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: labelArray });
            }

            const reviewersEnv = (process.env.DEFAULT_REVIEWERS || '')
              .split(',')
              .map((r) => r.trim())
              .filter(Boolean);
            const prAuthor = context.payload.pull_request.user.login;
            const reviewers = reviewersEnv.filter((reviewer) => reviewer !== prAuthor);
            if (reviewers.length > 0) {
              try {
                await github.rest.pulls.requestReviewers({ owner, repo, pull_number: prNumber, reviewers });
              } catch (error) {
                core.warning(`Unable to assign reviewers: ${error.message}`);
              }
            }

            const checklist = `<!-- pr-triage-agent -->\n### ðŸ¤– PR Triage Agent\n- [ ] Run \`npm run lint\`\n- [ ] Run \`npm run build\`\n- [ ] Attach UI screenshots for visual changes\n- [ ] Link an issue or provide rationale in the description`;

            const existingComments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });
            const botComment = existingComments.find((comment) => comment.body?.includes('<!-- pr-triage-agent -->'));

            if (botComment) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: botComment.id, body: checklist });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: checklist });
            }
