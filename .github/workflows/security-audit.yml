name: Dependency & Security Auditor

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'
  pull_request:
    paths:
      - package.json
      - package-lock.json

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --json > audit-report.json || true

      - name: Summarize vulnerabilities
        id: summarize
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { readFileSync } = require('fs');
            const path = require('path');
            const reportPath = path.join(process.cwd(), 'audit-report.json');
            const payload = JSON.parse(readFileSync(reportPath, 'utf8'));

            const vulnerabilities = payload.vulnerabilities || {};
            const findings = [];
            const severityRank = { critical: 4, high: 3, moderate: 2, low: 1 }; 

            for (const [name, detail] of Object.entries(vulnerabilities)) {
              if (!detail.via || detail.via.length === 0) continue;
              findings.push({
                name,
                severity: detail.severity || 'info',
                range: detail.range,
                via: detail.via.slice(0, 3).map((v) => typeof v === 'string' ? v : v.title).join('; ')
              });
            }

            findings.sort((a, b) => (severityRank[b.severity] || 0) - (severityRank[a.severity] || 0));
            const lines = findings.map((finding) => `- **${finding.name}** (${finding.severity}) â€“ ${finding.via}`);
            const summary = lines.length > 0 ? lines.join('\n') : 'âœ… No known vulnerabilities detected.';
            const hasHigh = findings.some((finding) => (severityRank[finding.severity] || 0) >= 3);

            core.setOutput('has-high', hasHigh ? 'true' : 'false');
            core.setOutput('summary', summary);

            if (context.payload.pull_request) {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = context.payload.pull_request.number;
              const body = `<!-- security-audit-agent -->\n### ðŸ” Dependency & Security Audit\n${summary}`;

              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100
              });
              const previous = comments.find((comment) => comment.body?.includes('<!-- security-audit-agent -->'));
              if (previous) {
                await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
              } else {
                await github.rest.issues.createComment({ owner, repo, issue_number, body });
              }
            }

            return summary;

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json

      - name: Fail on serious findings
        if: steps.summarize.outputs.has-high == 'true' && github.event_name == 'pull_request'
        run: |
          echo 'High severity vulnerabilities detected. Please address before merging.'
          exit 1
