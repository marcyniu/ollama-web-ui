name: Automated Code Review Agent

on:
  pull_request:
    types: [ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Summarize PR changes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: prNumber,
              per_page: 100
            });

            const stats = {
              frontend: 0,
              config: 0,
              docs: 0,
              dependencies: 0,
            };
            const touched = [];
            let uiFiles = 0;
            let dependencyTouches = [];

            for (const file of files) {
              const path = file.filename;
              if (path.startsWith('src/') || path.startsWith('public/')) {
                stats.frontend += file.changes;
                uiFiles += 1;
              }
              if (path === 'package.json' || path === 'package-lock.json') {
                stats.dependencies += file.changes;
                dependencyTouches.push(path);
              }
              if (path.startsWith('.github/') || ['vite.config.js', 'tailwind.config.js', 'postcss.config.js'].includes(path)) {
                stats.config += file.changes;
              }
              if (path === 'README.md' || path === 'CHANGELOG.md' || path.startsWith('docs/')) {
                stats.docs += file.changes;
              }
              touched.push(`- ${path} (+${file.additions} / -${file.deletions})`);
            }

            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const changedFiles = context.payload.pull_request.changed_files;

            const risks = [];
            if (additions + deletions > 500) {
              risks.push('Large diff detected (>500 lines). Consider splitting or reviewing carefully.');
            }
            if (stats.dependencies > 0 && !dependencyTouches.includes('package-lock.json')) {
              risks.push('Package changes detected without `package-lock.json`. Ensure lockfile is committed.');
            }
            if (uiFiles > 0) {
              risks.push('UI files changed â€” please provide before/after screenshots or a short loom.');
            }
            const hasTests = files.some((file) => /(test|spec|__tests__)/i.test(file.filename));
            if (!hasTests && stats.frontend > 0) {
              risks.push('No tests detected alongside UI changes. Consider adding regression coverage.');
            }

            const summaryParts = [`${changedFiles} files changed, ${additions} additions, ${deletions} deletions.`];
            if (stats.dependencies > 0) summaryParts.push('Dependencies updated. Double-check `npm run lint && npm run build`.');
            if (stats.config > 0) summaryParts.push('Build/config files touched â€” ensure CI matrix still passes.');
            if (stats.docs > 0) summaryParts.push('Docs updated ğŸ‘.');

            const header = `<!-- code-review-agent -->\n### ğŸ¤– Automated Code Review Summary\n${summaryParts.join('\n')}`;
            const risksBlock = risks.length ? `\n**Potential risks:**\n${risks.map((r) => `- ${r}`).join('\n')}` : '\nNo major automated risks detected.';
            const filesBlock = touched.length ? `\n**Touched files:**\n${touched.slice(0, 30).join('\n')}${touched.length > 30 ? '\n- â€¦ (truncated)' : ''}` : '';

            const body = `${header}${risksBlock}${filesBlock}`;

            const existingComments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });
            const previous = existingComments.find((comment) => comment.user?.login === 'github-actions[bot]' && comment.body?.includes('<!-- code-review-agent -->'));

            if (previous) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
            }
