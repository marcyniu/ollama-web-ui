name: PR Title & Changelog Normalizer

on:
  pull_request_target:
    types: [opened, edited, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  semantic-title:
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            chore
            refactor
            test
            ci
          requireScope: false

  changelog-hint:
    runs-on: ubuntu-latest
    needs: semantic-title
    steps:
      - name: Post changelog suggestion
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;
            const title = pr.title;
            const label = pr.labels?.map((l) => l.name).join(', ') || 'no labels';
            const changelogEntry = `- ${title} (PR #${issue_number})`;
            const body = `<!-- changelog-normalizer -->\n### ðŸ§¾ Suggested Changelog Entry\n${changelogEntry}\n\nLabels: ${label}`;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            const previous = comments.find((comment) => comment.body?.includes('<!-- changelog-normalizer -->'));
            if (previous) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
